<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo ì•±</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- í—¤ë” -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">ğŸ“ Todo ì•±</div>
                <div class="user-info" id="user-info">
                    <!-- ì‚¬ìš©ì ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main>
        <div class="container">
            <!-- ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="message"></div>

            <!-- Todo ì¶”ê°€ ë²„íŠ¼ -->
            <div class="card">
                <div class="add-todo-header">
                    <h2>í•  ì¼ ê´€ë¦¬</h2>
                    <button onclick="openAddModal()" class="btn btn-primary">
                        â• ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€
                    </button>
                </div>
            </div>

            <!-- í•„í„° ë° ê²€ìƒ‰ ì„¹ì…˜ -->
            <div class="card filter-card">
                <div class="filters">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                        <button class="filter-btn" data-filter="pending">ë¯¸ì™„ë£Œ</button>
                        <button class="filter-btn" data-filter="completed">ì™„ë£Œ</button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-input" class="form-control" placeholder="í•  ì¼ ê²€ìƒ‰...">
                    </div>
                    
                    <select id="sort-select" class="form-control">
                        <option value="default">ê¸°ë³¸ ì •ë ¬</option>
                        <option value="due_date_asc">ë§ˆê°ì¼ ë¹ ë¥¸ìˆœ</option>
                        <option value="due_date_desc">ë§ˆê°ì¼ ëŠ¦ì€ìˆœ</option>
                        <option value="progress_desc">ì§„í–‰ë¥  ë†’ì€ìˆœ</option>
                        <option value="progress_asc">ì§„í–‰ë¥  ë‚®ì€ìˆœ</option>
                    </select>
                </div>
            </div>

            <!-- Todo ëª©ë¡ ì„¹ì…˜ -->
            <div class="card">
                <div class="todo-list-header">
                    <h2>í•  ì¼ ëª©ë¡</h2>
                    <div class="view-toggle">
                        <button id="grid-view-btn" class="view-btn active" onclick="switchView('grid')">
                            ğŸ“‹ ê·¸ë¦¬ë“œ
                        </button>
                        <button id="calendar-view-btn" class="view-btn" onclick="switchView('calendar')">
                            ğŸ“… ìº˜ë¦°ë”
                        </button>
                    </div>
                </div>
                
                <!-- ê·¸ë¦¬ë“œ ë·° -->
                <div id="grid-view" class="view-content">
                    <ul id="todo-list" class="todo-list">
                        <li class="loading">
                            <div class="spinner"></div>
                            í•  ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </li>
                    </ul>
                </div>
                
                <!-- ìº˜ë¦°ë” ë·° -->
                <div id="calendar-view" class="view-content" style="display: none;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button id="today-btn" class="calendar-today-btn">ì˜¤ëŠ˜</button>
                            <div class="calendar-nav-center">
                                <button id="prev-month" class="calendar-nav">â€¹</button>
                                <h3 id="calendar-title" class="calendar-title-clickable">2024ë…„ 1ì›”</h3>
                                <button id="next-month" class="calendar-nav">â€º</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- ìº˜ë¦°ë”ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ì •ë³´ ì˜ì—­ -->
            <div class="user-info"></div>
            
            <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ ì¶”ê°€ -->
            <div class="test-buttons" style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                <h4>ğŸ”§ ë””ë²„ê¹… ë„êµ¬</h4>
                <button onclick="checkLoginStatus()" class="btn btn-sm btn-info">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸</button>
                <button onclick="checkTokens()" class="btn btn-sm btn-info">í† í° í™•ì¸</button>
                <button onclick="checkUserInfo()" class="btn btn-sm btn-info">ì‚¬ìš©ì ì •ë³´ í™•ì¸</button>
                <button onclick="testTodoInsert()" class="btn btn-sm btn-warning">í• ì¼ ì¶”ê°€ í…ŒìŠ¤íŠ¸</button>
                <button onclick="testDirectLogin()" class="btn btn-sm btn-success">ì§ì ‘ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
                <button onclick="forceRelogin()" class="btn btn-sm btn-danger">ê°•ì œ ì¬ë¡œê·¸ì¸</button>
                <div id="test-result" style="margin-top: 10px; padding: 10px; background: white; border-radius: 3px; min-height: 100px; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
            </div>
        </div>
    </main>

    <!-- Todo ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>í•  ì¼ ìˆ˜ì •</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-todo-form">
                    <input type="hidden" id="edit-todo-id">
                    
                    <div class="form-group">
                        <label for="edit-todo-title">ì œëª© *</label>
                        <input type="text" id="edit-todo-title" name="title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-todo-description">ì„¤ëª…</label>
                        <textarea id="edit-todo-description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group date-row">
                        <div class="date-input-group">
                            <label for="edit-todo-start-date">ğŸš€ ì‹œì‘ì¼</label>
                            <input type="datetime-local" id="edit-todo-start-date" name="start_date" class="form-control">
                        </div>
                        <div class="date-input-group">
                            <label for="edit-todo-due-date">ğŸ“… ë§ˆê°ì¼ *</label>
                            <input type="datetime-local" id="edit-todo-due-date" name="due_date" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-todo-progress">ì§„í–‰ë¥  (%)</label>
                        <input type="range" id="edit-todo-progress" name="progress" class="form-control" min="0" max="100">
                        <span id="edit-progress-display">0%</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">ìˆ˜ì • ì™„ë£Œ</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Todo ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="add-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="todo-form">
                    <div class="form-group">
                        <label for="todo-title">ì œëª© *</label>
                        <input type="text" id="todo-title" name="title" class="form-control" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="todo-description">ì„¤ëª…</label>
                        <textarea id="todo-description" name="description" class="form-control" rows="3" placeholder="ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”... (ì„ íƒì‚¬í•­)"></textarea>
                    </div>
                    
                    <div class="form-group date-row">
                        <div class="date-input-group">
                            <label for="todo-start-date">ğŸš€ ì‹œì‘ì¼</label>
                            <input type="datetime-local" id="todo-start-date" name="start_date" class="form-control">
                        </div>
                        <div class="date-input-group">
                            <label for="todo-due-date">ğŸ“… ë§ˆê°ì¼ *</label>
                            <input type="datetime-local" id="todo-due-date" name="due_date" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="todo-progress">ì§„í–‰ë¥  (%)</label>
                        <input type="range" id="todo-progress" name="progress" class="form-control" min="0" max="100" value="0">
                        <span id="progress-display">0%</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">í•  ì¼ ì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddModal()">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ -->
    <div id="date-picker-modal" class="modal date-picker-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ë‚ ì§œ ì„ íƒ</h3>
                <button class="modal-close" onclick="closeDatePicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="date-picker-container">
                    <div class="date-picker-group">
                        <label for="year-select">ë…„ë„</label>
                        <select id="year-select" class="form-control">
                            <!-- ë…„ë„ ì˜µì…˜ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </select>
                    </div>
                    <div class="date-picker-group">
                        <label for="month-select">ì›”</label>
                        <select id="month-select" class="form-control">
                            <option value="0">1ì›”</option>
                            <option value="1">2ì›”</option>
                            <option value="2">3ì›”</option>
                            <option value="3">4ì›”</option>
                            <option value="4">5ì›”</option>
                            <option value="5">6ì›”</option>
                            <option value="6">7ì›”</option>
                            <option value="7">8ì›”</option>
                            <option value="8">9ì›”</option>
                            <option value="9">10ì›”</option>
                            <option value="10">11ì›”</option>
                            <option value="11">12ì›”</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button onclick="goToSelectedDate()" class="btn btn-primary">ì´ë™</button>
                    <button onclick="closeDatePicker()" class="btn btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>íšŒì›ì •ë³´ ë³€ê²½</h3>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-group">
                        <label for="profile-email">ì´ë©”ì¼ (ë³€ê²½ ë¶ˆê°€)</label>
                        <input type="email" id="profile-email" name="email" class="form-control" readonly disabled>
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-name">ì´ë¦„</label>
                        <input type="text" id="profile-name" name="full_name" class="form-control" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    
                    <hr>
                    <h4>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                    <p class="form-text">ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ì•„ë˜ í•„ë“œë“¤ì„ ë¹„ì›Œë‘ì„¸ìš”.</p>
                    
                    <div class="form-group">
                        <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="current-password" name="current_password" class="form-control" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <small class="form-text">ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë ¤ë©´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="new-password" name="new_password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <small class="form-text">6ì ì´ìƒ, ì˜ë¬¸ì+ìˆ«ì</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="confirm-password" name="confirm_password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">ë³€ê²½ ì™„ë£Œ</button>
                        <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;" onclick="closeAllModals()"></div>

    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="fix_supabase.js"></script>
    <script src="fix_supabase_api.js"></script>
    <script src="show_sql.js"></script>
    <script src="add_progress_column.js"></script>
    <script src="add_start_date_column.js"></script>

    <script>
        // ì§„í–‰ë¥  ìŠ¬ë¼ì´ë” ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        document.getElementById('todo-progress').addEventListener('input', function(e) {
            document.getElementById('progress-display').textContent = e.target.value + '%'
        })

        document.getElementById('edit-todo-progress').addEventListener('input', function(e) {
            document.getElementById('edit-progress-display').textContent = e.target.value + '%'
        })

        // ì‹œì‘ì¼ì„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¤ì •
        function setDefaultStartDate() {
            const now = new Date()
            // ë¡œì»¬ ì‹œê°„ëŒ€ì— ë§ì¶° YYYY-MM-DDTHH:MM í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const year = now.getFullYear()
            const month = String(now.getMonth() + 1).padStart(2, '0')
            const day = String(now.getDate()).padStart(2, '0')
            const hours = String(now.getHours()).padStart(2, '0')
            const minutes = String(now.getMinutes()).padStart(2, '0')
            
            const todayDateTime = `${year}-${month}-${day}T${hours}:${minutes}`
            
            const startDateInput = document.getElementById('todo-start-date')
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = todayDateTime
            }
        }

        // í”„ë¡œí•„ í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault()
            
            const formData = new FormData(e.target)
            const fullName = formData.get('full_name').trim()
            const currentPassword = formData.get('current_password')
            const newPassword = formData.get('new_password')
            const confirmPassword = formData.get('confirm_password')
            
            try {
                const testLoggedIn = localStorage.getItem('test_logged_in')
                
                // ì´ë¦„ ë³€ê²½ ì²˜ë¦¬
                if (fullName) {
                    if (testLoggedIn === 'true') {
                        // í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ì´ë¦„ ë³€ê²½
                        localStorage.setItem('test_user_name', fullName)
                        SupabaseUtils.showSuccess('ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!')
                    } else {
                        // DirectSupabaseAPIë¡œ í”„ë¡œí•„ ì—…ë°ì´íŠ¸
                        const user = await SupabaseUtils.getCurrentUser()
                        if (user) {
                            const result = await DirectSupabaseAPI.updateProfile(user.id, { name: fullName })
                            if (result.error) {
                                SupabaseUtils.showError('ì´ë¦„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error.message)
                                return
                            }
                            SupabaseUtils.showSuccess('ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!')
                        }
                    }
                }
                
                // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì²˜ë¦¬
                if (currentPassword && newPassword) {
                    // ìœ íš¨ì„± ê²€ì‚¬
                    if (newPassword.length < 6) {
                        SupabaseUtils.showError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.')
                        return
                    }
                    
                    if (!/[A-Za-z]/.test(newPassword) || !/\d/.test(newPassword)) {
                        SupabaseUtils.showError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ìì™€ ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.')
                        return
                    }
                    
                    if (newPassword !== confirmPassword) {
                        SupabaseUtils.showError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                        return
                    }
                    
                    if (testLoggedIn === 'true') {
                        // í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜
                        SupabaseUtils.showSuccess('í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!')
                    } else {
                        // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                        const email = document.getElementById('profile-email').value
                        const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: currentPassword
                        })
                        
                        if (signInError) {
                            SupabaseUtils.showError('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                            return
                        }
                        
                        // ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½
                        const { error: updateError } = await supabaseClient.auth.updateUser({
                            password: newPassword
                        })
                        
                        if (updateError) {
                            SupabaseUtils.showError('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + updateError.message)
                            return
                        }
                        
                        SupabaseUtils.showSuccess('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!')
                    }
                }
                
                // ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ í‘œì‹œ
                await Auth.displayUserInfo()
                
                // ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeProfileModal()
                }, 1500)
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ë³€ê²½ ì˜¤ë¥˜:', error)
                SupabaseUtils.showError('í”„ë¡œí•„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message)
            }
        })

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì‹œì‘ì¼ ì„¤ì •
        document.addEventListener('DOMContentLoaded', setDefaultStartDate)
        
        // í¼ ë¦¬ì…‹ í›„ì—ë„ ì‹œì‘ì¼ ë‹¤ì‹œ ì„¤ì •
        document.getElementById('todo-form').addEventListener('reset', function() {
            setTimeout(setDefaultStartDate, 100) // ë¦¬ì…‹ í›„ ì ì‹œ ê¸°ë‹¤ë¦° í›„ ì„¤ì •
        })

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openAddModal() {
            const modal = document.getElementById('add-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
            
            // ì‹œì‘ì¼ ê¸°ë³¸ê°’ ì„¤ì •
            setDefaultStartDate()
        }

        // í”„ë¡œí•„ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function openProfileModal() {
            const modal = document.getElementById('profile-modal')
            const overlay = document.getElementById('modal-overlay')
            
            // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            await loadCurrentUserProfile()
            
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
            
            // í¼ ë¦¬ì…‹
            document.getElementById('profile-form').reset()
        }

        // í˜„ì¬ ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
        async function loadCurrentUserProfile() {
            try {
                const testLoggedIn = localStorage.getItem('test_logged_in')
                
                if (testLoggedIn === 'true') {
                    // í…ŒìŠ¤íŠ¸ ëª¨ë“œ
                    const testUserEmail = localStorage.getItem('test_user_email') || 'test@example.com'
                    const testUserName = localStorage.getItem('test_user_name') || 'ì°¨ì •í›ˆ'
                    
                    document.getElementById('profile-email').value = testUserEmail
                    document.getElementById('profile-name').value = testUserName
                } else {
                    // ì‹¤ì œ Supabase ì‚¬ìš©ì
                    const user = await SupabaseUtils.getCurrentUser()
                    if (user) {
                        document.getElementById('profile-email').value = user.email
                        
                        // DirectSupabaseAPIë¡œ í”„ë¡œí•„ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                        try {
                            const profileResult = await DirectSupabaseAPI.getProfile(user.id)
                            if (profileResult.data && profileResult.data.name) {
                                document.getElementById('profile-name').value = profileResult.data.name
                            } else if (user.user_metadata && user.user_metadata.full_name) {
                                document.getElementById('profile-name').value = user.user_metadata.full_name
                            }
                        } catch (error) {
                            console.warn('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error)
                            if (user.user_metadata && user.user_metadata.full_name) {
                                document.getElementById('profile-name').value = user.user_metadata.full_name
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error)
                SupabaseUtils.showError('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
            }
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
            
            // í¼ ë¦¬ì…‹
            document.getElementById('todo-form').reset()
            document.getElementById('progress-display').textContent = '0%'
        }

        function openEditModal(todoId) {
            const modal = document.getElementById('edit-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
            
            // Todo ë°ì´í„° ë¡œë“œ
            if (window.TodoApp) {
                TodoApp.loadTodoForEdit(todoId)
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
        }

        function closeAllModals() {
            closeAddModal()
            closeEditModal()
            closeProfileModal()
            closeDatePicker()
        }

        // ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openDatePicker() {
            const modal = document.getElementById('date-picker-modal')
            const overlay = document.getElementById('modal-overlay')
            
            // ë…„ë„ ì˜µì…˜ ìƒì„± (í˜„ì¬ ë…„ë„ ê¸°ì¤€ Â±10ë…„)
            const yearSelect = document.getElementById('year-select')
            const currentYear = new Date().getFullYear()
            yearSelect.innerHTML = ''
            
            for (let year = currentYear - 10; year <= currentYear + 10; year++) {
                const option = document.createElement('option')
                option.value = year
                option.textContent = year + 'ë…„'
                if (year === currentDate.getFullYear()) {
                    option.selected = true
                }
                yearSelect.appendChild(option)
            }
            
            // í˜„ì¬ ì›” ì„ íƒ
            document.getElementById('month-select').value = currentDate.getMonth()
            
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
        }

        function closeDatePicker() {
            const modal = document.getElementById('date-picker-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
        }

        function goToSelectedDate() {
            const year = parseInt(document.getElementById('year-select').value)
            const month = parseInt(document.getElementById('month-select').value)
            
            currentDate = new Date(year, month, 1)
            renderCalendar()
            closeDatePicker()
        }

        function goToToday() {
            currentDate = new Date()
            renderCalendar()
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals()
            }
        })

        // ë·° ì „í™˜ í•¨ìˆ˜
        let currentView = 'grid'
        let currentDate = new Date()

        function switchView(view) {
            currentView = view
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'))
            document.getElementById(view + '-view-btn').classList.add('active')
            
            // ë·° ì „í™˜
            document.getElementById('grid-view').style.display = view === 'grid' ? 'block' : 'none'
            document.getElementById('calendar-view').style.display = view === 'calendar' ? 'block' : 'none'
            
            if (view === 'calendar') {
                renderCalendar()
            }
        }

        // ìº˜ë¦°ë” ë Œë”ë§
        function renderCalendar() {
            const year = currentDate.getFullYear()
            const month = currentDate.getMonth()
            
            // ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('calendar-title').textContent = `${year}ë…„ ${month + 1}ì›”`
            
            // ìº˜ë¦°ë” ê·¸ë¦¬ë“œ ìƒì„±
            const calendarGrid = document.getElementById('calendar-grid')
            calendarGrid.innerHTML = ''
            
            // ìš”ì¼ í—¤ë”
            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']
            dayHeaders.forEach(day => {
                const header = document.createElement('div')
                header.className = 'calendar-day-header'
                header.textContent = day
                calendarGrid.appendChild(header)
            })
            
            // ì´ë²ˆ ë‹¬ ì²« ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
            const firstDay = new Date(year, month, 1)
            const lastDay = new Date(year, month + 1, 0)
            const startDate = new Date(firstDay)
            startDate.setDate(startDate.getDate() - firstDay.getDay())
            
            // 42ì¼ í‘œì‹œ (6ì£¼)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate)
                date.setDate(startDate.getDate() + i)
                
                const dayElement = document.createElement('div')
                dayElement.className = 'calendar-day'
                
                // ë‹¤ë¥¸ ë‹¬ í‘œì‹œ
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month')
                }
                
                // ì˜¤ëŠ˜ í‘œì‹œ
                const today = new Date()
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today')
                }
                
                dayElement.innerHTML = `
                    <div class="calendar-day-number">${date.getDate()}</div>
                    <div class="calendar-todos" id="calendar-todos-${date.toISOString().split('T')[0]}">
                    </div>
                `
                
                calendarGrid.appendChild(dayElement)
            }
            
            // Todo ë°ì´í„° í‘œì‹œ
            if (window.TodoApp && window.TodoApp.todos) {
                renderCalendarTodos()
            }
        }

        // ìº˜ë¦°ë”ì— Todo í‘œì‹œ
        function renderCalendarTodos() {
            if (!window.TodoApp || !window.TodoApp.todos) return
            
            window.TodoApp.todos.forEach(todo => {
                const dates = []
                
                // ì‹œì‘ì¼ê³¼ ë§ˆê°ì¼ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš° - ê¸°ê°„ ì „ì²´ í‘œì‹œ
                if (todo.start_date && todo.due_date) {
                    const startDate = new Date(todo.start_date.split('T')[0])
                    const endDate = new Date(todo.due_date.split('T')[0])
                    
                    // ì‹œì‘ì¼ë¶€í„° ë§ˆê°ì¼ê¹Œì§€ ëª¨ë“  ë‚ ì§œ ì¶”ê°€
                    const currentDate = new Date(startDate)
                    while (currentDate <= endDate) {
                        const dateStr = currentDate.toISOString().split('T')[0]
                        let type = 'middle'
                        
                        if (currentDate.getTime() === startDate.getTime()) {
                            type = 'start'
                        } else if (currentDate.getTime() === endDate.getTime()) {
                            type = 'due'
                        }
                        
                        dates.push({ date: dateStr, type: type })
                        currentDate.setDate(currentDate.getDate() + 1)
                    }
                } else {
                    // ì‹œì‘ì¼ ë˜ëŠ” ë§ˆê°ì¼ ì¤‘ í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš°
                    if (todo.start_date) dates.push({ date: todo.start_date.split('T')[0], type: 'start' })
                    if (todo.due_date) dates.push({ date: todo.due_date.split('T')[0], type: 'due' })
                }
                
                dates.forEach(({ date, type }) => {
                    const container = document.getElementById(`calendar-todos-${date}`)
                    
                    if (container) {
                        const todoElement = document.createElement('div')
                        todoElement.className = 'calendar-todo-item'
                        
                        // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì ìš©
                        if (type === 'start') {
                            todoElement.classList.add('todo-start')
                        } else if (type === 'due') {
                            todoElement.classList.add('todo-due')
                        } else if (type === 'middle') {
                            todoElement.classList.add('todo-middle')
                        }
                        
                        if (todo.completed) {
                            todoElement.classList.add('completed')
                        } else if (type === 'due' && new Date(date) < new Date()) {
                            todoElement.classList.add('overdue')
                        }
                        
                        // ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì„¤ì •
                        let prefix = ''
                        let displayText = todo.title
                        
                        if (type === 'start') {
                            prefix = 'ğŸš€'
                            displayText = todo.title
                        } else if (type === 'due') {
                            prefix = 'ğŸ“…'
                            displayText = todo.title
                        } else if (type === 'middle') {
                            prefix = 'â–¶'
                            displayText = todo.title
                        }
                        
                        todoElement.textContent = `${prefix} ${displayText}`
                        todoElement.title = `${todo.title}${todo.description ? '\n' + todo.description : ''}`
                        todoElement.onclick = () => openEditModal(todo.id)
                        
                        container.appendChild(todoElement)
                    }
                })
            })
        }

        // ìº˜ë¦°ë” ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('DOMContentLoaded', function() {
            // ì´ì „/ë‹¤ìŒ ì›” ë²„íŠ¼
            document.getElementById('prev-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1)
                renderCalendar()
            })
            
            document.getElementById('next-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1)
                renderCalendar()
            })
            
            // ì˜¤ëŠ˜ ë²„íŠ¼
            document.getElementById('today-btn').addEventListener('click', goToToday)
            
            // ìº˜ë¦°ë” ì œëª© í´ë¦­ (ë¹ ë¥¸ ì´ë™)
            document.getElementById('calendar-title').addEventListener('click', openDatePicker)
        })

        // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testSupabaseConnection() {
            console.log('Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ë¨')
            
            if (window.SupabaseUtils) {
                const result = await SupabaseUtils.testConnection()
                
                if (result.success) {
                    SupabaseUtils.showSuccess('âœ… Supabase ì—°ê²° ì„±ê³µ!')
                } else {
                    SupabaseUtils.showError('âŒ Supabase ì—°ê²° ì‹¤íŒ¨: ' + result.error)
                }
            } else {
                alert('SupabaseUtilsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
            }
        }

        // ì‹¤ì œ Supabase ëª¨ë“œ í† ê¸€
        function toggleRealSupabase() {
            const isTestMode = localStorage.getItem('test_logged_in') === 'true'
            const btn = document.getElementById('toggle-supabase-btn')
            
            if (isTestMode) {
                // ì‹¤ì œ Supabase ëª¨ë“œë¡œ ì „í™˜
                localStorage.removeItem('test_logged_in')
                localStorage.removeItem('test_user_email')
                btn.textContent = 'í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜'
                SupabaseUtils.showSuccess('ì‹¤ì œ Supabase ëª¨ë“œë¡œ ì „í™˜ë¨')
                setTimeout(() => window.location.reload(), 1000)
            } else {
                // í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜
                localStorage.setItem('test_logged_in', 'true')
                localStorage.setItem('test_user_email', 'test@example.com')
                btn.textContent = 'ì‹¤ì œ Supabase í™œì„±í™”'
                SupabaseUtils.showSuccess('í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜ë¨')
                setTimeout(() => window.location.reload(), 1000)
            }
        }
    </script>
</body>
</html> 