<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo 앱 - 할 일 관리</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 헤더 -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">📝 Todo 앱</div>
                <div class="user-info" id="user-info">
                    <!-- 사용자 정보가 여기에 동적으로 로드됩니다 -->
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 콘텐츠 -->
    <main>
        <div class="container">
            <!-- 메시지 영역 -->
            <div id="message"></div>

            <!-- Todo 추가 버튼 -->
            <div class="card">
                <div class="add-todo-header">
                    <h2>할 일 관리</h2>
                    <button onclick="openAddModal()" class="btn btn-primary">
                        ➕ 새로운 할 일 추가
                    </button>
                </div>
            </div>

            <!-- 필터 및 검색 섹션 -->
            <div class="card filter-card">
                <div class="filters">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">전체</button>
                        <button class="filter-btn" data-filter="pending">미완료</button>
                        <button class="filter-btn" data-filter="completed">완료</button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-input" class="form-control" placeholder="할 일 검색...">
                    </div>
                    
                    <select id="sort-select" class="form-control">
                        <option value="default">기본 정렬</option>
                        <option value="due_date_asc">마감일 빠른순</option>
                        <option value="due_date_desc">마감일 늦은순</option>
                        <option value="progress_desc">진행률 높은순</option>
                        <option value="progress_asc">진행률 낮은순</option>
                    </select>
                </div>
            </div>

            <!-- Todo 목록 섹션 -->
            <div class="card">
                <div class="todo-list-header">
                    <h2>할 일 목록</h2>
                    <div class="view-toggle">
                        <button id="grid-view-btn" class="view-btn active" onclick="switchView('grid')">
                            📋 그리드
                        </button>
                        <button id="calendar-view-btn" class="view-btn" onclick="switchView('calendar')">
                            📅 캘린더
                        </button>
                    </div>
                </div>
                
                <!-- 그리드 뷰 -->
                <div id="grid-view" class="view-content">
                    <ul id="todo-list" class="todo-list">
                        <li class="loading">
                            <div class="spinner"></div>
                            할 일을 불러오는 중...
                        </li>
                    </ul>
                </div>
                
                <!-- 캘린더 뷰 -->
                <div id="calendar-view" class="view-content" style="display: none;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-nav-left">
                                <button id="prev-month" class="calendar-nav">‹</button>
                                <button id="today-btn" class="calendar-today-btn">오늘</button>
                            </div>
                            <h3 id="calendar-title" class="calendar-title-clickable">2024년 1월</h3>
                            <button id="next-month" class="calendar-nav">›</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- 캘린더가 여기에 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Todo 수정 모달 -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>할 일 수정</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-todo-form">
                    <input type="hidden" id="edit-todo-id">
                    
                    <div class="form-group">
                        <label for="edit-todo-title">제목 *</label>
                        <input type="text" id="edit-todo-title" name="title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-todo-description">설명</label>
                        <textarea id="edit-todo-description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group date-row">
                        <div class="date-input-group">
                            <label for="edit-todo-start-date">🚀 시작일</label>
                            <input type="datetime-local" id="edit-todo-start-date" name="start_date" class="form-control">
                        </div>
                        <div class="date-input-group">
                            <label for="edit-todo-due-date">📅 마감일 *</label>
                            <input type="datetime-local" id="edit-todo-due-date" name="due_date" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-todo-progress">진행률 (%)</label>
                        <input type="range" id="edit-todo-progress" name="progress" class="form-control" min="0" max="100">
                        <span id="edit-progress-display">0%</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">수정 완료</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Todo 추가 모달 -->
    <div id="add-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>새로운 할 일 추가</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="todo-form">
                    <div class="form-group">
                        <label for="todo-title">제목 *</label>
                        <input type="text" id="todo-title" name="title" class="form-control" placeholder="할 일을 입력하세요..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="todo-description">설명</label>
                        <textarea id="todo-description" name="description" class="form-control" rows="3" placeholder="상세 설명을 입력하세요... (선택사항)"></textarea>
                    </div>
                    
                    <div class="form-group date-row">
                        <div class="date-input-group">
                            <label for="todo-start-date">🚀 시작일</label>
                            <input type="datetime-local" id="todo-start-date" name="start_date" class="form-control">
                        </div>
                        <div class="date-input-group">
                            <label for="todo-due-date">📅 마감일 *</label>
                            <input type="datetime-local" id="todo-due-date" name="due_date" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="todo-progress">진행률 (%)</label>
                        <input type="range" id="todo-progress" name="progress" class="form-control" min="0" max="100" value="0">
                        <span id="progress-display">0%</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">할 일 추가</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 날짜 선택 모달 -->
    <div id="date-picker-modal" class="modal date-picker-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>날짜 선택</h3>
                <button class="modal-close" onclick="closeDatePicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="date-picker-container">
                    <div class="date-picker-group">
                        <label for="year-select">년도</label>
                        <select id="year-select" class="form-control">
                            <!-- 년도 옵션이 동적으로 생성됩니다 -->
                        </select>
                    </div>
                    <div class="date-picker-group">
                        <label for="month-select">월</label>
                        <select id="month-select" class="form-control">
                            <option value="0">1월</option>
                            <option value="1">2월</option>
                            <option value="2">3월</option>
                            <option value="3">4월</option>
                            <option value="4">5월</option>
                            <option value="5">6월</option>
                            <option value="6">7월</option>
                            <option value="7">8월</option>
                            <option value="8">9월</option>
                            <option value="9">10월</option>
                            <option value="10">11월</option>
                            <option value="11">12월</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button onclick="goToSelectedDate()" class="btn btn-primary">이동</button>
                    <button onclick="closeDatePicker()" class="btn btn-secondary">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달 오버레이 -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;" onclick="closeAllModals()"></div>

    <!-- JavaScript 파일들 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="fix_supabase.js"></script>
    <script src="fix_supabase_api.js"></script>
    <script src="show_sql.js"></script>
    <script src="add_progress_column.js"></script>
    <script src="add_start_date_column.js"></script>

    <script>
        // 진행률 슬라이더 실시간 업데이트
        document.getElementById('todo-progress').addEventListener('input', function(e) {
            document.getElementById('progress-display').textContent = e.target.value + '%'
        })

        document.getElementById('edit-todo-progress').addEventListener('input', function(e) {
            document.getElementById('edit-progress-display').textContent = e.target.value + '%'
        })

        // 시작일을 오늘 날짜로 기본 설정
        function setDefaultStartDate() {
            const now = new Date()
            // 로컬 시간대에 맞춰 YYYY-MM-DDTHH:MM 형식으로 변환
            const year = now.getFullYear()
            const month = String(now.getMonth() + 1).padStart(2, '0')
            const day = String(now.getDate()).padStart(2, '0')
            const hours = String(now.getHours()).padStart(2, '0')
            const minutes = String(now.getMinutes()).padStart(2, '0')
            
            const todayDateTime = `${year}-${month}-${day}T${hours}:${minutes}`
            
            const startDateInput = document.getElementById('todo-start-date')
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = todayDateTime
            }
        }

        // 페이지 로드 시 기본 시작일 설정
        document.addEventListener('DOMContentLoaded', setDefaultStartDate)
        
        // 폼 리셋 후에도 시작일 다시 설정
        document.getElementById('todo-form').addEventListener('reset', function() {
            setTimeout(setDefaultStartDate, 100) // 리셋 후 잠시 기다린 후 설정
        })

        // 모달 관련 함수들
        function openAddModal() {
            const modal = document.getElementById('add-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
            
            // 시작일 기본값 설정
            setDefaultStartDate()
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
            
            // 폼 리셋
            document.getElementById('todo-form').reset()
            document.getElementById('progress-display').textContent = '0%'
        }

        function openEditModal(todoId) {
            const modal = document.getElementById('edit-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
            
            // Todo 데이터 로드
            if (window.TodoApp) {
                TodoApp.loadTodoForEdit(todoId)
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
        }

        function closeAllModals() {
            closeAddModal()
            closeEditModal()
            closeDatePicker()
        }

        // 날짜 선택 모달 관련 함수들
        function openDatePicker() {
            const modal = document.getElementById('date-picker-modal')
            const overlay = document.getElementById('modal-overlay')
            
            // 년도 옵션 생성 (현재 년도 기준 ±10년)
            const yearSelect = document.getElementById('year-select')
            const currentYear = new Date().getFullYear()
            yearSelect.innerHTML = ''
            
            for (let year = currentYear - 10; year <= currentYear + 10; year++) {
                const option = document.createElement('option')
                option.value = year
                option.textContent = year + '년'
                if (year === currentDate.getFullYear()) {
                    option.selected = true
                }
                yearSelect.appendChild(option)
            }
            
            // 현재 월 선택
            document.getElementById('month-select').value = currentDate.getMonth()
            
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
        }

        function closeDatePicker() {
            const modal = document.getElementById('date-picker-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
        }

        function goToSelectedDate() {
            const year = parseInt(document.getElementById('year-select').value)
            const month = parseInt(document.getElementById('month-select').value)
            
            currentDate = new Date(year, month, 1)
            renderCalendar()
            closeDatePicker()
        }

        function goToToday() {
            currentDate = new Date()
            renderCalendar()
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals()
            }
        })

        // 뷰 전환 함수
        let currentView = 'grid'
        let currentDate = new Date()

        function switchView(view) {
            currentView = view
            
            // 버튼 상태 업데이트
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'))
            document.getElementById(view + '-view-btn').classList.add('active')
            
            // 뷰 전환
            document.getElementById('grid-view').style.display = view === 'grid' ? 'block' : 'none'
            document.getElementById('calendar-view').style.display = view === 'calendar' ? 'block' : 'none'
            
            if (view === 'calendar') {
                renderCalendar()
            }
        }

        // 캘린더 렌더링
        function renderCalendar() {
            const year = currentDate.getFullYear()
            const month = currentDate.getMonth()
            
            // 제목 업데이트
            document.getElementById('calendar-title').textContent = `${year}년 ${month + 1}월`
            
            // 캘린더 그리드 생성
            const calendarGrid = document.getElementById('calendar-grid')
            calendarGrid.innerHTML = ''
            
            // 요일 헤더
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토']
            dayHeaders.forEach(day => {
                const header = document.createElement('div')
                header.className = 'calendar-day-header'
                header.textContent = day
                calendarGrid.appendChild(header)
            })
            
            // 이번 달 첫 날과 마지막 날
            const firstDay = new Date(year, month, 1)
            const lastDay = new Date(year, month + 1, 0)
            const startDate = new Date(firstDay)
            startDate.setDate(startDate.getDate() - firstDay.getDay())
            
            // 42일 표시 (6주)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate)
                date.setDate(startDate.getDate() + i)
                
                const dayElement = document.createElement('div')
                dayElement.className = 'calendar-day'
                
                // 다른 달 표시
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month')
                }
                
                // 오늘 표시
                const today = new Date()
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today')
                }
                
                dayElement.innerHTML = `
                    <div class="calendar-day-number">${date.getDate()}</div>
                    <div class="calendar-todos" id="calendar-todos-${date.toISOString().split('T')[0]}">
                    </div>
                `
                
                calendarGrid.appendChild(dayElement)
            }
            
            // Todo 데이터 표시
            if (window.TodoApp && window.TodoApp.todos) {
                renderCalendarTodos()
            }
        }

        // 캘린더에 Todo 표시
        function renderCalendarTodos() {
            if (!window.TodoApp || !window.TodoApp.todos) return
            
            window.TodoApp.todos.forEach(todo => {
                const dates = []
                
                // 시작일과 마감일이 모두 있는 경우 - 기간 전체 표시
                if (todo.start_date && todo.due_date) {
                    const startDate = new Date(todo.start_date.split('T')[0])
                    const endDate = new Date(todo.due_date.split('T')[0])
                    
                    // 시작일부터 마감일까지 모든 날짜 추가
                    const currentDate = new Date(startDate)
                    while (currentDate <= endDate) {
                        const dateStr = currentDate.toISOString().split('T')[0]
                        let type = 'middle'
                        
                        if (currentDate.getTime() === startDate.getTime()) {
                            type = 'start'
                        } else if (currentDate.getTime() === endDate.getTime()) {
                            type = 'due'
                        }
                        
                        dates.push({ date: dateStr, type: type })
                        currentDate.setDate(currentDate.getDate() + 1)
                    }
                } else {
                    // 시작일 또는 마감일 중 하나만 있는 경우
                    if (todo.start_date) dates.push({ date: todo.start_date.split('T')[0], type: 'start' })
                    if (todo.due_date) dates.push({ date: todo.due_date.split('T')[0], type: 'due' })
                }
                
                dates.forEach(({ date, type }) => {
                    const container = document.getElementById(`calendar-todos-${date}`)
                    
                    if (container) {
                        const todoElement = document.createElement('div')
                        todoElement.className = 'calendar-todo-item'
                        
                        // 타입별 스타일 적용
                        if (type === 'start') {
                            todoElement.classList.add('todo-start')
                        } else if (type === 'due') {
                            todoElement.classList.add('todo-due')
                        } else if (type === 'middle') {
                            todoElement.classList.add('todo-middle')
                        }
                        
                        if (todo.completed) {
                            todoElement.classList.add('completed')
                        } else if (type === 'due' && new Date(date) < new Date()) {
                            todoElement.classList.add('overdue')
                        }
                        
                        // 아이콘과 텍스트 설정
                        let prefix = ''
                        let displayText = todo.title
                        
                        if (type === 'start') {
                            prefix = '🚀'
                            displayText = todo.title
                        } else if (type === 'due') {
                            prefix = '📅'
                            displayText = todo.title
                        } else if (type === 'middle') {
                            prefix = '▶'
                            displayText = todo.title
                        }
                        
                        todoElement.textContent = `${prefix} ${displayText}`
                        todoElement.title = `${todo.title}${todo.description ? '\n' + todo.description : ''}`
                        todoElement.onclick = () => openEditModal(todo.id)
                        
                        container.appendChild(todoElement)
                    }
                })
            })
        }

        // 캘린더 네비게이션
        document.addEventListener('DOMContentLoaded', function() {
            // 이전/다음 월 버튼
            document.getElementById('prev-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1)
                renderCalendar()
            })
            
            document.getElementById('next-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1)
                renderCalendar()
            })
            
            // 오늘 버튼
            document.getElementById('today-btn').addEventListener('click', goToToday)
            
            // 캘린더 제목 클릭 (빠른 이동)
            document.getElementById('calendar-title').addEventListener('click', openDatePicker)
        })

        // Supabase 연결 테스트 함수
        async function testSupabaseConnection() {
            console.log('Supabase 연결 테스트 버튼 클릭됨')
            
            if (window.SupabaseUtils) {
                const result = await SupabaseUtils.testConnection()
                
                if (result.success) {
                    SupabaseUtils.showSuccess('✅ Supabase 연결 성공!')
                } else {
                    SupabaseUtils.showError('❌ Supabase 연결 실패: ' + result.error)
                }
            } else {
                alert('SupabaseUtils가 로드되지 않았습니다.')
            }
        }

        // 실제 Supabase 모드 토글
        function toggleRealSupabase() {
            const isTestMode = localStorage.getItem('test_logged_in') === 'true'
            const btn = document.getElementById('toggle-supabase-btn')
            
            if (isTestMode) {
                // 실제 Supabase 모드로 전환
                localStorage.removeItem('test_logged_in')
                localStorage.removeItem('test_user_email')
                btn.textContent = '테스트 모드로 전환'
                SupabaseUtils.showSuccess('실제 Supabase 모드로 전환됨')
                setTimeout(() => window.location.reload(), 1000)
            } else {
                // 테스트 모드로 전환
                localStorage.setItem('test_logged_in', 'true')
                localStorage.setItem('test_user_email', 'test@example.com')
                btn.textContent = '실제 Supabase 활성화'
                SupabaseUtils.showSuccess('테스트 모드로 전환됨')
                setTimeout(() => window.location.reload(), 1000)
            }
        }
    </script>
</body>
</html> 