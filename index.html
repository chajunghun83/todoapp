<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo 앱</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 헤더 -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">📝 Todo 앱</div>
                <div class="user-info" id="user-info">
                    <!-- 사용자 정보가 여기에 동적으로 로드됩니다 -->
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 콘텐츠 -->
    <main>
        <div class="container">
            <!-- 메시지 영역 -->
            <div id="message"></div>

            <!-- Todo 추가 버튼 -->
            <div class="card">
                <div class="add-todo-header">
                    <h2>할 일 관리</h2>
                    <button onclick="openAddModal()" class="btn btn-primary">
                        ➕ 새로운 할 일 추가
                    </button>
                </div>
            </div>

            <!-- 필터 및 검색 섹션 -->
            <div class="card filter-card">
                <div class="filters">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">전체</button>
                        <button class="filter-btn" data-filter="pending">미완료</button>
                        <button class="filter-btn" data-filter="completed">완료</button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-input" class="form-control" placeholder="할 일 검색...">
                    </div>
                    
                    <select id="sort-select" class="form-control">
                        <option value="default">기본 정렬</option>
                        <option value="due_date_asc">마감일 빠른순</option>
                        <option value="due_date_desc">마감일 늦은순</option>
                        <option value="progress_desc">진행률 높은순</option>
                        <option value="progress_asc">진행률 낮은순</option>
                    </select>
                </div>
            </div>

            <!-- Todo 목록 섹션 -->
            <div class="card">
                <div class="todo-list-header">
                    <h2>할 일 목록</h2>
                    <div class="view-toggle">
                        <button id="grid-view-btn" class="view-btn active" onclick="switchView('grid')">
                            📋 그리드
                        </button>
                        <button id="calendar-view-btn" class="view-btn" onclick="switchView('calendar')">
                            📅 캘린더
                        </button>
                    </div>
                </div>
                
                <!-- 그리드 뷰 -->
                <div id="grid-view" class="view-content">
                    <ul id="todo-list" class="todo-list">
                        <li class="loading">
                            <div class="spinner"></div>
                            할 일을 불러오는 중...
                        </li>
                    </ul>
                </div>
                
                <!-- 캘린더 뷰 -->
                <div id="calendar-view" class="view-content" style="display: none;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button id="today-btn" class="calendar-today-btn">오늘</button>
                            <div class="calendar-nav-center">
                                <button id="prev-month" class="calendar-nav">‹</button>
                                <h3 id="calendar-title" class="calendar-title-clickable">2024년 1월</h3>
                                <button id="next-month" class="calendar-nav">›</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- 캘린더가 여기에 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 사용자 정보 영역 -->
            <div class="user-info"></div>
            
            <!-- 테스트 버튼들 추가 -->
            <div class="test-buttons" style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                <h4>🔧 디버깅 도구</h4>
                <button onclick="checkLoginStatus()" class="btn btn-sm btn-info">로그인 상태 확인</button>
                <button onclick="checkTokens()" class="btn btn-sm btn-info">토큰 확인</button>
                <button onclick="checkUserInfo()" class="btn btn-sm btn-info">사용자 정보 확인</button>
                <button onclick="testTodoInsert()" class="btn btn-sm btn-warning">할일 추가 테스트</button>
                <button onclick="testDirectLogin()" class="btn btn-sm btn-success">직접 로그인 테스트</button>
                <button onclick="forceRelogin()" class="btn btn-sm btn-danger">강제 재로그인</button>
                <button onclick="debugCalendarDates()" class="btn btn-sm btn-primary">📅 캘린더 날짜 디버깅</button>
                <button onclick="addDummyData()" class="btn btn-sm btn-warning">🎭 더미 데이터 추가</button>
                <div id="test-result" style="margin-top: 10px; padding: 10px; background: white; border-radius: 3px; min-height: 100px; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
            </div>
            
            <!-- 날짜 디버깅 전용 영역 -->
            <div id="date-debug-panel" style="margin: 10px 0; padding: 15px; background: #e8f4fd; border: 2px solid #2196F3; border-radius: 8px; display: none;">
                <h4>📅 날짜 디버깅 패널</h4>
                <div style="margin-bottom: 15px;">
                    <button onclick="addTestTodoWithDates()" class="btn btn-primary">테스트 할일 추가 (6월 24-25일)</button>
                    <button onclick="showAllTodoDates()" class="btn btn-info">모든 할일 날짜 분석</button>
                    <button onclick="testDateConversion()" class="btn btn-warning">날짜 변환 테스트</button>
                    <button onclick="clearDateDebug()" class="btn btn-secondary">디버그 창 지우기</button>
                </div>
                <div id="date-debug-result" style="background: white; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; min-height: 200px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;"></div>
            </div>
        </div>
    </main>

    <!-- Todo 수정 모달 -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>할 일 수정</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-todo-form">
                    <input type="hidden" id="edit-todo-id">
                    
                    <div class="form-group">
                        <label for="edit-todo-title">제목 *</label>
                        <input type="text" id="edit-todo-title" name="title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-todo-description">설명</label>
                        <textarea id="edit-todo-description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group date-row">
                        <div class="date-input-group">
                            <label for="edit-todo-start-date">🚀 시작일</label>
                            <input type="datetime-local" id="edit-todo-start-date" name="start_date" class="form-control">
                        </div>
                        <div class="date-input-group">
                            <label for="edit-todo-due-date">📅 마감일 *</label>
                            <input type="datetime-local" id="edit-todo-due-date" name="due_date" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-todo-progress">진행률 (%)</label>
                        <input type="range" id="edit-todo-progress" name="progress" class="form-control" min="0" max="100">
                        <span id="edit-progress-display">0%</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">수정 완료</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Todo 추가 모달 -->
    <div id="add-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>새로운 할 일 추가</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="todo-form">
                    <div class="form-group">
                        <label for="todo-title">제목 *</label>
                        <input type="text" id="todo-title" name="title" class="form-control" placeholder="할 일을 입력하세요..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="todo-description">설명</label>
                        <textarea id="todo-description" name="description" class="form-control" rows="3" placeholder="상세 설명을 입력하세요... (선택사항)"></textarea>
                    </div>
                    
                    <div class="form-group date-row">
                        <div class="date-input-group">
                            <label for="todo-start-date">🚀 시작일</label>
                            <input type="datetime-local" id="todo-start-date" name="start_date" class="form-control">
                        </div>
                        <div class="date-input-group">
                            <label for="todo-due-date">📅 마감일 *</label>
                            <input type="datetime-local" id="todo-due-date" name="due_date" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="todo-progress">진행률 (%)</label>
                        <input type="range" id="todo-progress" name="progress" class="form-control" min="0" max="100" value="0">
                        <span id="progress-display">0%</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">할 일 추가</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 날짜 선택 모달 -->
    <div id="date-picker-modal" class="modal date-picker-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>날짜 선택</h3>
                <button class="modal-close" onclick="closeDatePicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="date-picker-container">
                    <div class="date-picker-group">
                        <label for="year-select">년도</label>
                        <select id="year-select" class="form-control">
                            <!-- 년도 옵션이 동적으로 생성됩니다 -->
                        </select>
                    </div>
                    <div class="date-picker-group">
                        <label for="month-select">월</label>
                        <select id="month-select" class="form-control">
                            <option value="0">1월</option>
                            <option value="1">2월</option>
                            <option value="2">3월</option>
                            <option value="3">4월</option>
                            <option value="4">5월</option>
                            <option value="5">6월</option>
                            <option value="6">7월</option>
                            <option value="7">8월</option>
                            <option value="8">9월</option>
                            <option value="9">10월</option>
                            <option value="10">11월</option>
                            <option value="11">12월</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button onclick="goToSelectedDate()" class="btn btn-primary">이동</button>
                    <button onclick="closeDatePicker()" class="btn btn-secondary">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 프로필 변경 모달 -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>회원정보 변경</h3>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-group">
                        <label for="profile-email">이메일 (변경 불가)</label>
                        <input type="email" id="profile-email" name="email" class="form-control" readonly disabled>
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-name">이름</label>
                        <input type="text" id="profile-name" name="full_name" class="form-control" placeholder="이름을 입력하세요">
                    </div>
                    
                    <hr>
                    <h4>비밀번호 변경</h4>
                    <p class="form-text">비밀번호를 변경하지 않으려면 아래 필드들을 비워두세요.</p>
                    
                    <div class="form-group">
                        <label for="current-password">현재 비밀번호</label>
                        <input type="password" id="current-password" name="current_password" class="form-control" placeholder="현재 비밀번호를 입력하세요">
                        <small class="form-text">비밀번호를 변경하려면 현재 비밀번호를 입력하세요</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">새 비밀번호</label>
                        <input type="password" id="new-password" name="new_password" class="form-control" placeholder="새 비밀번호를 입력하세요">
                        <small class="form-text">6자 이상, 영문자+숫자</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-password">새 비밀번호 확인</label>
                        <input type="password" id="confirm-password" name="confirm_password" class="form-control" placeholder="새 비밀번호를 다시 입력하세요">
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">변경 완료</button>
                        <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 모달 오버레이 -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;" onclick="closeAllModals()"></div>

    <!-- JavaScript 파일들 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="fix_supabase.js"></script>
    <script src="fix_supabase_api.js"></script>
    <script src="show_sql.js"></script>
    <script src="add_progress_column.js"></script>
    <script src="add_start_date_column.js"></script>
    <script src="add_dummy_data.js"></script>

    <script>
        // 진행률 슬라이더 실시간 업데이트
        document.getElementById('todo-progress').addEventListener('input', function(e) {
            document.getElementById('progress-display').textContent = e.target.value + '%'
        })

        document.getElementById('edit-todo-progress').addEventListener('input', function(e) {
            document.getElementById('edit-progress-display').textContent = e.target.value + '%'
        })

        // 시작일을 오늘 날짜로 기본 설정
        function setDefaultStartDate() {
            const now = new Date()
            // 로컬 시간대에 맞춰 YYYY-MM-DDTHH:MM 형식으로 변환
            const year = now.getFullYear()
            const month = String(now.getMonth() + 1).padStart(2, '0')
            const day = String(now.getDate()).padStart(2, '0')
            const hours = String(now.getHours()).padStart(2, '0')
            const minutes = String(now.getMinutes()).padStart(2, '0')
            
            const todayDateTime = `${year}-${month}-${day}T${hours}:${minutes}`
            
            const startDateInput = document.getElementById('todo-start-date')
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = todayDateTime
            }
        }

        // 프로필 폼 제출 처리
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault()
            
            const formData = new FormData(e.target)
            const fullName = formData.get('full_name').trim()
            const currentPassword = formData.get('current_password')
            const newPassword = formData.get('new_password')
            const confirmPassword = formData.get('confirm_password')
            
            try {
                const testLoggedIn = localStorage.getItem('test_logged_in')
                
                // 이름 변경 처리
                if (fullName) {
                    if (testLoggedIn === 'true') {
                        // 테스트 모드에서 이름 변경
                        localStorage.setItem('test_user_name', fullName)
                        SupabaseUtils.showSuccess('이름이 변경되었습니다!')
                    } else {
                        // DirectSupabaseAPI로 프로필 업데이트
                        const user = await SupabaseUtils.getCurrentUser()
                        if (user) {
                            const result = await DirectSupabaseAPI.updateProfile(user.id, { name: fullName })
                            if (result.error) {
                                SupabaseUtils.showError('이름 변경에 실패했습니다: ' + result.error.message)
                                return
                            }
                            SupabaseUtils.showSuccess('이름이 변경되었습니다!')
                        }
                    }
                }
                
                // 비밀번호 변경 처리
                if (currentPassword && newPassword) {
                    // 유효성 검사
                    if (newPassword.length < 6) {
                        SupabaseUtils.showError('새 비밀번호는 6자 이상이어야 합니다.')
                        return
                    }
                    
                    if (!/[A-Za-z]/.test(newPassword) || !/\d/.test(newPassword)) {
                        SupabaseUtils.showError('새 비밀번호는 영문자와 숫자를 포함해야 합니다.')
                        return
                    }
                    
                    if (newPassword !== confirmPassword) {
                        SupabaseUtils.showError('새 비밀번호가 일치하지 않습니다.')
                        return
                    }
                    
                    if (testLoggedIn === 'true') {
                        // 테스트 모드에서는 비밀번호 변경 시뮬레이션
                        SupabaseUtils.showSuccess('테스트 모드: 비밀번호가 변경되었습니다!')
                    } else {
                        // 현재 비밀번호 확인
                        const email = document.getElementById('profile-email').value
                        const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: currentPassword
                        })
                        
                        if (signInError) {
                            SupabaseUtils.showError('현재 비밀번호가 올바르지 않습니다.')
                            return
                        }
                        
                        // 새 비밀번호로 변경
                        const { error: updateError } = await supabaseClient.auth.updateUser({
                            password: newPassword
                        })
                        
                        if (updateError) {
                            SupabaseUtils.showError('비밀번호 변경에 실패했습니다: ' + updateError.message)
                            return
                        }
                        
                        SupabaseUtils.showSuccess('비밀번호가 변경되었습니다!')
                    }
                }
                
                // 사용자 정보 다시 표시
                await Auth.displayUserInfo()
                
                // 모달 닫기
                setTimeout(() => {
                    closeProfileModal()
                }, 1500)
                
            } catch (error) {
                console.error('프로필 변경 오류:', error)
                SupabaseUtils.showError('프로필 변경에 실패했습니다: ' + error.message)
            }
        })

        // 페이지 로드 시 기본 시작일 설정
        document.addEventListener('DOMContentLoaded', setDefaultStartDate)
        
        // 폼 리셋 후에도 시작일 다시 설정
        document.getElementById('todo-form').addEventListener('reset', function() {
            setTimeout(setDefaultStartDate, 100) // 리셋 후 잠시 기다린 후 설정
        })

        // 모달 관련 함수들
        function openAddModal() {
            const modal = document.getElementById('add-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
            
            // 시작일 기본값 설정
            setDefaultStartDate()
        }

        // 프로필 모달 관련 함수들
        async function openProfileModal() {
            const modal = document.getElementById('profile-modal')
            const overlay = document.getElementById('modal-overlay')
            
            // 현재 사용자 정보 로드
            await loadCurrentUserProfile()
            
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
            
            // 폼 리셋
            document.getElementById('profile-form').reset()
        }

        // 현재 사용자 프로필 정보 로드
        async function loadCurrentUserProfile() {
            try {
                const testLoggedIn = localStorage.getItem('test_logged_in')
                
                if (testLoggedIn === 'true') {
                    // 테스트 모드
                    const testUserEmail = localStorage.getItem('test_user_email') || 'test@example.com'
                    const testUserName = localStorage.getItem('test_user_name') || '차정훈'
                    
                    document.getElementById('profile-email').value = testUserEmail
                    document.getElementById('profile-name').value = testUserName
                } else {
                    // 실제 Supabase 사용자
                    const user = await SupabaseUtils.getCurrentUser()
                    if (user) {
                        document.getElementById('profile-email').value = user.email
                        
                        // DirectSupabaseAPI로 프로필에서 이름 가져오기
                        try {
                            const profileResult = await DirectSupabaseAPI.getProfile(user.id)
                            if (profileResult.data && profileResult.data.name) {
                                document.getElementById('profile-name').value = profileResult.data.name
                            } else if (user.user_metadata && user.user_metadata.full_name) {
                                document.getElementById('profile-name').value = user.user_metadata.full_name
                            }
                        } catch (error) {
                            console.warn('프로필 로드 실패:', error)
                            if (user.user_metadata && user.user_metadata.full_name) {
                                document.getElementById('profile-name').value = user.user_metadata.full_name
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('사용자 프로필 로드 실패:', error)
                SupabaseUtils.showError('프로필 정보를 불러올 수 없습니다.')
            }
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
            
            // 폼 리셋
            document.getElementById('todo-form').reset()
            document.getElementById('progress-display').textContent = '0%'
        }

        function openEditModal(todoId) {
            const modal = document.getElementById('edit-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
            
            // Todo 데이터 로드
            if (window.TodoApp) {
                TodoApp.loadTodoForEdit(todoId)
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
        }

        function closeAllModals() {
            closeAddModal()
            closeEditModal()
            closeProfileModal()
            closeDatePicker()
        }

        // 날짜 선택 모달 관련 함수들
        function openDatePicker() {
            const modal = document.getElementById('date-picker-modal')
            const overlay = document.getElementById('modal-overlay')
            
            // 년도 옵션 생성 (현재 년도 기준 ±10년)
            const yearSelect = document.getElementById('year-select')
            const currentYear = new Date().getFullYear()
            yearSelect.innerHTML = ''
            
            for (let year = currentYear - 10; year <= currentYear + 10; year++) {
                const option = document.createElement('option')
                option.value = year
                option.textContent = year + '년'
                if (year === currentDate.getFullYear()) {
                    option.selected = true
                }
                yearSelect.appendChild(option)
            }
            
            // 현재 월 선택
            document.getElementById('month-select').value = currentDate.getMonth()
            
            modal.style.display = 'block'
            overlay.style.display = 'block'
            document.body.style.overflow = 'hidden'
        }

        function closeDatePicker() {
            const modal = document.getElementById('date-picker-modal')
            const overlay = document.getElementById('modal-overlay')
            modal.style.display = 'none'
            overlay.style.display = 'none'
            document.body.style.overflow = 'auto'
        }

        function goToSelectedDate() {
            const year = parseInt(document.getElementById('year-select').value)
            const month = parseInt(document.getElementById('month-select').value)
            
            currentDate = new Date(year, month, 1)
            renderCalendar()
            closeDatePicker()
        }

        function goToToday() {
            currentDate = new Date()
            renderCalendar()
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals()
            }
        })

        // 뷰 전환 함수
        let currentView = 'grid'
        let currentDate = new Date()

        function switchView(view) {
            currentView = view
            
            // 버튼 상태 업데이트
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'))
            document.getElementById(view + '-view-btn').classList.add('active')
            
            // 뷰 전환
            document.getElementById('grid-view').style.display = view === 'grid' ? 'block' : 'none'
            document.getElementById('calendar-view').style.display = view === 'calendar' ? 'block' : 'none'
            
            if (view === 'calendar') {
                renderCalendar()
            }
        }

        // 캘린더 렌더링
        function renderCalendar() {
            const year = currentDate.getFullYear()
            const month = currentDate.getMonth()
            
            // 제목 업데이트
            document.getElementById('calendar-title').textContent = `${year}년 ${month + 1}월`
            
            // 캘린더 그리드 생성
            const calendarGrid = document.getElementById('calendar-grid')
            calendarGrid.innerHTML = ''
            
            // 요일 헤더
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토']
            dayHeaders.forEach(day => {
                const header = document.createElement('div')
                header.className = 'calendar-day-header'
                header.textContent = day
                calendarGrid.appendChild(header)
            })
            
            // 이번 달 첫 날과 마지막 날
            const firstDay = new Date(year, month, 1)
            const lastDay = new Date(year, month + 1, 0)
            const startDate = new Date(firstDay)
            startDate.setDate(startDate.getDate() - firstDay.getDay())
            
            // 42일 표시 (6주)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate)
                date.setDate(startDate.getDate() + i)
                
                const dayElement = document.createElement('div')
                dayElement.className = 'calendar-day'
                
                // 다른 달 표시
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month')
                }
                
                // 오늘 표시
                const today = new Date()
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today')
                }
                
                // 로컬 날짜로 날짜 문자열 생성 (시간대 문제 해결)
                const dateYear = date.getFullYear()
                const dateMonth = String(date.getMonth() + 1).padStart(2, '0')
                const dateDay = String(date.getDate()).padStart(2, '0')
                const dateStr = `${dateYear}-${dateMonth}-${dateDay}`
                
                dayElement.innerHTML = `
                    <div class="calendar-day-number">${date.getDate()}</div>
                    <div class="calendar-todos" id="calendar-todos-${dateStr}">
                    </div>
                `
                
                calendarGrid.appendChild(dayElement)
            }
            
            // Todo 데이터 표시
            if (window.TodoApp && window.TodoApp.todos) {
                renderCalendarTodos()
            }
        }

        // 캘린더에 Todo 표시
        function renderCalendarTodos() {
            if (!window.TodoApp || !window.TodoApp.todos) return
            
            console.log('🔍 캘린더 Todo 렌더링 시작')
            
            window.TodoApp.todos.forEach(todo => {
                console.log('📝 처리 중인 Todo:', {
                    title: todo.title,
                    start_date: todo.start_date,
                    due_date: todo.due_date
                })
                
                const dates = []
                
                // UTC 기준으로 날짜 생성하여 시간대 문제 해결
                function createLocalDate(dateString) {
                    const datePart = dateString.split('T')[0]
                    console.log('📅 날짜 파싱:', { original: dateString, datePart })
                    // UTC 기준으로 날짜 생성 (시간대 문제 해결)
                    const utcDate = new Date(datePart + 'T00:00:00Z')
                    console.log('🕐 생성된 UTC 날짜:', { 
                        input: datePart, 
                        result: utcDate.toDateString(),
                        resultISO: utcDate.toISOString().split('T')[0]
                    })
                    return utcDate
                }
                
                // 시작일과 마감일이 모두 있는 경우 - 기간 전체 표시
                if (todo.start_date && todo.due_date) {
                    const startDate = createLocalDate(todo.start_date)
                    const endDate = createLocalDate(todo.due_date)
                    
                    // 시작일부터 마감일까지 모든 날짜 추가
                    const currentDate = new Date(startDate)
                    while (currentDate <= endDate) {
                        // UTC 기준으로 날짜 문자열 생성
                        const dateStr = currentDate.toISOString().split('T')[0]
                        
                        let type = 'middle'
                        
                        if (currentDate.getTime() === startDate.getTime()) {
                            type = 'start'
                        } else if (currentDate.getTime() === endDate.getTime()) {
                            type = 'due'
                        }
                        
                        console.log('📆 캘린더 날짜 생성:', {
                            currentDate: currentDate.toDateString(),
                            dateStr,
                            type,
                            startDate: startDate.toDateString(),
                            endDate: endDate.toDateString()
                        })
                        
                        dates.push({ date: dateStr, type: type })
                        currentDate.setUTCDate(currentDate.getUTCDate() + 1)
                    }
                } else {
                    // 시작일 또는 마감일 중 하나만 있는 경우
                    if (todo.start_date) {
                        const startDate = createLocalDate(todo.start_date)
                        const finalDate = startDate.toISOString().split('T')[0]
                        console.log('🚀 시작일 최종 처리:', { originalDate: todo.start_date, finalDate })
                        dates.push({ date: finalDate, type: 'start' })
                    }
                    if (todo.due_date) {
                        const dueDate = createLocalDate(todo.due_date)
                        const finalDate = dueDate.toISOString().split('T')[0]
                        console.log('📅 마감일 최종 처리:', { originalDate: todo.due_date, finalDate })
                        dates.push({ date: finalDate, type: 'due' })
                    }
                }
                
                dates.forEach(({ date, type }) => {
                    const containerId = `calendar-todos-${date}`
                    const container = document.getElementById(containerId)
                    
                    console.log('🔍 컨테이너 찾기:', {
                        date,
                        type,
                        containerId,
                        containerFound: !!container
                    })
                    
                    if (container) {
                        const todoElement = document.createElement('div')
                        todoElement.className = 'calendar-todo-item'
                        
                        // 타입별 스타일 적용
                        if (type === 'start') {
                            todoElement.classList.add('todo-start')
                        } else if (type === 'due') {
                            todoElement.classList.add('todo-due')
                        } else if (type === 'middle') {
                            todoElement.classList.add('todo-middle')
                        }
                        
                        if (todo.completed) {
                            todoElement.classList.add('completed')
                        } else if (type === 'due') {
                            // 마감일 확인 시 UTC 기준으로 비교
                            const todoDate = new Date(date + 'T00:00:00Z')
                            const today = new Date()
                            const todayUTC = new Date(today.getFullYear(), today.getMonth(), today.getDate())
                            
                            if (todoDate < todayUTC) {
                                todoElement.classList.add('overdue')
                            }
                        }
                        
                        // 아이콘과 텍스트 설정
                        let prefix = ''
                        let displayText = todo.title
                        
                        if (type === 'start') {
                            prefix = '🚀'
                            displayText = todo.title
                        } else if (type === 'due') {
                            prefix = '📅'
                            displayText = todo.title
                        } else if (type === 'middle') {
                            prefix = '▶'
                            displayText = todo.title
                        }
                        
                        todoElement.textContent = `${prefix} ${displayText}`
                        todoElement.title = `${todo.title}${todo.description ? '\n' + todo.description : ''}`
                        todoElement.onclick = () => openEditModal(todo.id)
                        
                        container.appendChild(todoElement)
                    }
                })
            })
        }

        // 캘린더 네비게이션
        document.addEventListener('DOMContentLoaded', function() {
            // 이전/다음 월 버튼
            document.getElementById('prev-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1)
                renderCalendar()
            })
            
            document.getElementById('next-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1)
                renderCalendar()
            })
            
            // 오늘 버튼
            document.getElementById('today-btn').addEventListener('click', goToToday)
            
            // 캘린더 제목 클릭 (빠른 이동)
            document.getElementById('calendar-title').addEventListener('click', openDatePicker)
        })

        // Supabase 연결 테스트 함수
        async function testSupabaseConnection() {
            console.log('Supabase 연결 테스트 버튼 클릭됨')
            
            if (window.SupabaseUtils) {
                const result = await SupabaseUtils.testConnection()
                
                if (result.success) {
                    SupabaseUtils.showSuccess('✅ Supabase 연결 성공!')
                } else {
                    SupabaseUtils.showError('❌ Supabase 연결 실패: ' + result.error)
                }
            } else {
                alert('SupabaseUtils가 로드되지 않았습니다.')
            }
        }

        // 실제 Supabase 모드 토글
        function toggleRealSupabase() {
            const isTestMode = localStorage.getItem('test_logged_in') === 'true'
            const btn = document.getElementById('toggle-supabase-btn')
            
            if (isTestMode) {
                // 실제 Supabase 모드로 전환
                localStorage.removeItem('test_logged_in')
                localStorage.removeItem('test_user_email')
                btn.textContent = '테스트 모드로 전환'
                SupabaseUtils.showSuccess('실제 Supabase 모드로 전환됨')
                setTimeout(() => window.location.reload(), 1000)
            } else {
                // 테스트 모드로 전환
                localStorage.setItem('test_logged_in', 'true')
                localStorage.setItem('test_user_email', 'test@example.com')
                btn.textContent = '실제 Supabase 활성화'
                SupabaseUtils.showSuccess('테스트 모드로 전환됨')
                setTimeout(() => window.location.reload(), 1000)
            }
        }

        // 📅 날짜 디버깅 함수들
        function debugCalendarDates() {
            const panel = document.getElementById('date-debug-panel')
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none'
            
            if (panel.style.display === 'block') {
                showAllTodoDates()
            }
        }

        function addTestTodoWithDates() {
            const debugResult = document.getElementById('date-debug-result')
            debugResult.textContent += '\n🚀 테스트 할일 추가 중...\n'
            
            // 현재 날짜 기준으로 6월 24일, 25일 설정
            const now = new Date()
            const year = now.getFullYear()
            const startDate = `${year}-06-24T13:29:00`
            const dueDate = `${year}-06-25T13:29:00`
            
            debugResult.textContent += `입력 날짜:\n`
            debugResult.textContent += `  시작일: ${startDate}\n`
            debugResult.textContent += `  마감일: ${dueDate}\n\n`
            
            // 테스트 할일 추가
            if (window.TodoApp) {
                const testTodo = {
                    id: 'test-' + Date.now(),
                    title: '날짜 테스트 할일',
                    description: '6월 24일 시작, 6월 25일 마감',
                    start_date: startDate,
                    due_date: dueDate,
                    progress: 0,
                    completed: false,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }
                
                // 테스트 모드에서 직접 추가
                const testLoggedIn = localStorage.getItem('test_logged_in')
                if (testLoggedIn === 'true') {
                    window.TodoApp.todos.push(testTodo)
                    window.TodoApp.renderTodos()
                    debugResult.textContent += '✅ 테스트 할일이 추가되었습니다!\n\n'
                    
                    // 캘린더가 활성화되어 있으면 렌더링
                    if (currentView === 'calendar') {
                        renderCalendar()
                    }
                    
                    // 추가된 할일의 날짜 분석
                    analyzeTodoDate(testTodo)
                } else {
                    debugResult.textContent += '❌ 테스트 모드가 아닙니다. 로그인 후 다시 시도하세요.\n\n'
                }
            }
        }

        function showAllTodoDates() {
            const debugResult = document.getElementById('date-debug-result')
            debugResult.textContent = '📊 모든 할일 날짜 분석\n' + '='.repeat(50) + '\n\n'
            
            if (!window.TodoApp || !window.TodoApp.todos || window.TodoApp.todos.length === 0) {
                debugResult.textContent += '❌ 할일이 없습니다.\n'
                return
            }
            
            window.TodoApp.todos.forEach((todo, index) => {
                debugResult.textContent += `📝 할일 ${index + 1}: ${todo.title}\n`
                debugResult.textContent += `   ID: ${todo.id}\n`
                
                if (todo.start_date) {
                    analyzeTodoDate(todo, 'start_date')
                }
                
                if (todo.due_date) {
                    analyzeTodoDate(todo, 'due_date')
                }
                
                debugResult.textContent += '\n' + '-'.repeat(40) + '\n\n'
            })
        }

        function analyzeTodoDate(todo, dateField = null) {
            const debugResult = document.getElementById('date-debug-result')
            
            const dates = dateField ? [dateField] : ['start_date', 'due_date']
            
            dates.forEach(field => {
                if (!todo[field]) return
                
                const originalDate = todo[field]
                debugResult.textContent += `📅 ${field === 'start_date' ? '시작일' : '마감일'} 분석:\n`
                debugResult.textContent += `   원본: ${originalDate}\n`
                
                // 1. 원본 Date 객체 생성
                const originalDateObj = new Date(originalDate)
                debugResult.textContent += `   원본 Date: ${originalDateObj.toString()}\n`
                debugResult.textContent += `   원본 ISO: ${originalDateObj.toISOString()}\n`
                debugResult.textContent += `   원본 날짜만: ${originalDateObj.toISOString().split('T')[0]}\n`
                
                // 2. 이전 방식 (문제가 있던 방식)
                const datePart = originalDate.split('T')[0]
                const [year, month, day] = datePart.split('-').map(Number)
                const oldLocalDate = new Date(year, month - 1, day)
                
                debugResult.textContent += `   [이전방식] 파싱된 부분: ${datePart}\n`
                debugResult.textContent += `   [이전방식] 파싱된 값: year=${year}, month=${month}, day=${day}\n`
                debugResult.textContent += `   [이전방식] 로컬 Date: ${oldLocalDate.toString()}\n`
                debugResult.textContent += `   [이전방식] 로컬 ISO: ${oldLocalDate.toISOString()}\n`
                debugResult.textContent += `   [이전방식] 로컬 날짜만: ${oldLocalDate.toISOString().split('T')[0]}\n`
                
                // 3. 새로운 UTC 방식
                const utcDate = new Date(datePart + 'T00:00:00Z')
                debugResult.textContent += `   [새방식] UTC Date: ${utcDate.toString()}\n`
                debugResult.textContent += `   [새방식] UTC ISO: ${utcDate.toISOString()}\n`
                debugResult.textContent += `   [새방식] UTC 날짜만: ${utcDate.toISOString().split('T')[0]}\n`
                
                // 4. 최종 캘린더 표시 날짜 (새 방식)
                const finalDate = utcDate.toISOString().split('T')[0]
                debugResult.textContent += `   최종 표시: ${finalDate}\n`
                
                // 5. 차이점 분석
                const oldFinalDate = oldLocalDate.toISOString().split('T')[0]
                debugResult.textContent += `   비교: 원본=${datePart}, 이전방식=${oldFinalDate}, 새방식=${finalDate}\n`
                
                if (datePart !== oldFinalDate) {
                    debugResult.textContent += `   ⚠️ 이전방식 문제: ${datePart} → ${oldFinalDate} (하루 밀림)\n`
                } else {
                    debugResult.textContent += `   ✅ 이전방식 OK\n`
                }
                
                if (datePart !== finalDate) {
                    debugResult.textContent += `   ⚠️ 새방식 문제: ${datePart} → ${finalDate}\n`
                } else {
                    debugResult.textContent += `   ✅ 새방식 OK - 날짜 정확!\n`
                }
                
                debugResult.textContent += '\n'
            })
        }

        function testDateConversion() {
            const debugResult = document.getElementById('date-debug-result')
            debugResult.textContent = '🧪 날짜 변환 테스트\n' + '='.repeat(50) + '\n\n'
            
            const testDates = [
                '2025-06-24T13:29:00',
                '2025-06-25T13:29:00',
                '2025-06-24T00:00:00',
                '2025-06-25T23:59:59',
                '2025-06-24',
                '2025-06-25'
            ]
            
            testDates.forEach(testDate => {
                debugResult.textContent += `🔍 테스트 날짜: ${testDate}\n`
                
                // 방법 1: 직접 new Date()
                const method1 = new Date(testDate)
                debugResult.textContent += `   방법1 (new Date): ${method1.toString()}\n`
                debugResult.textContent += `   방법1 날짜만: ${method1.toISOString().split('T')[0]}\n`
                
                // 방법 2: 현재 로직 (split으로 날짜 부분만)
                const datePart = testDate.split('T')[0]
                const [year, month, day] = datePart.split('-').map(Number)
                const method2 = new Date(year, month - 1, day)
                debugResult.textContent += `   방법2 (로컬생성): ${method2.toString()}\n`
                debugResult.textContent += `   방법2 날짜만: ${method2.toISOString().split('T')[0]}\n`
                
                // 방법 3: UTC 기준
                const method3 = new Date(datePart + 'T00:00:00Z')
                debugResult.textContent += `   방법3 (UTC): ${method3.toString()}\n`
                debugResult.textContent += `   방법3 날짜만: ${method3.toISOString().split('T')[0]}\n`
                
                debugResult.textContent += '\n'
            })
            
            // 현재 시간대 정보
            const now = new Date()
            debugResult.textContent += `🌍 현재 시간대 정보:\n`
            debugResult.textContent += `   현재 시간: ${now.toString()}\n`
            debugResult.textContent += `   시간대 오프셋: ${now.getTimezoneOffset()}분\n`
            debugResult.textContent += `   시간대 오프셋: ${now.getTimezoneOffset() / 60}시간\n\n`
        }

        function clearDateDebug() {
            document.getElementById('date-debug-result').textContent = ''
        }
    </script>
</body>
</html> 